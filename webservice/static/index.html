<!DOCTYPE html>
<html>
<head>
    <title>CGI Detection</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <!-- For broader compatibility, a favicon.ico should also be provided. -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #0056b3;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 20px auto;
        }
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }
        #drop-zone.dragover {
            background-color: #e9ecef;
        }
        input[type="file"] {
            display: none;
        }
        input[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        #analysisDuration {
            margin-top: 10px;
            padding: 10px 15px;
            border: 1px solid #d4edda;
            border-radius: 4px;
            background-color: #f0fdf4;
            color: #155724;
            font-weight: bold;
        }
        .prediction-cgi {
            color: red;
            font-weight: bold;
        }
        .prediction-real {
            color: green;
            font-weight: bold;
        }
        #report {
            margin-top: 20px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .report-table th {
            background-color: #f2f2f2;
        }
        .infographic-bar {
            height: 20px;
            width: 100%;
            background-color: #ddd;
            position: relative;
            border-radius: 4px;
            margin-top: 5px;
        }
        .normal-range {
            height: 100%;
            background-color: #a5d6a7;
            position: absolute;
            border-radius: 4px;
        }
        .score-marker {
            height: 100%;
            width: 4px;
            background-color: #ef5350;
            position: absolute;
            border-radius: 2px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 5px;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Upload Image for CGI Detection</h1>
        <form id="uploadForm" enctype="multipart/form-data">
            <div id="drop-zone">
                <p>Drag & drop an image here, or click to select a file</p>
                <input type="file" name="file" accept="image/*" required>
            </div>
            <input type="submit" value="Analyze Image" id="analyzeButton" style="display: none;">
        </form>

        <div id="imagePreviewContainer" style="display: none; position: relative; margin-top: 20px;">
            <img id="imagePreview" src="#" alt="Image Preview" style="max-width: 100%; height: auto; border-radius: 8px;"/>
            <button id="clearImageButton" style="position: absolute; top: 10px; right: 10px; background-color: rgba(255, 255, 255, 0.7); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer;">&times;</button>
        </div>

        <!-- Progress Indicator -->
        <div id="progressContainer" style="display: none; margin-top: 20px;">
            <h4>Analyzing Image...</h4>
            <div id="progressBar" style="width: 100%; background-color: #ddd; border-radius: 4px;">
                <div id="progressBarFill" style="width: 0%; height: 20px; background-color: #007bff; border-radius: 4px; text-align: center; color: white; line-height: 20px;"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 5px;"></p>
        </div>

        <div id="results">
            <!-- Results will be displayed here -->
        </div>
        <div id="analysisDuration">
            <!-- Analysis duration will be displayed here -->
        </div>
        <div id="report">
            <!-- Detailed report will be displayed here -->
        </div>

        <!-- Reporting Section -->
        <div id="reportingContainer" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; background-color: #f9f9f9;">
            <button id="showReportFormButton">Report Incorrect Result</button>
            <form id="reportForm" style="display: none; margin-top: 10px;">
                <label for="correctionType">This image was incorrectly identified. It is actually:</label>
                <select name="correctionType" id="correctionType" required>
                    <option value="false_cgi">A real photo (falsely marked as CGI)</option>
                    <option value="false_real">A CGI image (falsely marked as Real)</option>
                </select>
                <button type="submit" style="margin-left: 10px;">Submit Report</button>
            </form>
            <div id="reportStatus"></div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = dropZone.querySelector('input[type="file"]');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const clearImageButton = document.getElementById('clearImageButton');
        const analyzeButton = document.getElementById('analyzeButton');
        const resultsDiv = document.getElementById('results');
        const reportDiv = document.getElementById('report');
        const reportingContainer = document.getElementById('reportingContainer');
        const showReportFormButton = document.getElementById('showReportFormButton');
        const reportForm = document.getElementById('reportForm');
        const reportStatus = document.getElementById('reportStatus');
        const progressContainer = document.getElementById('progressContainer');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressText = document.getElementById('progressText');

        let lastAnalysisResult = null;
        let lastImageFile = null;
        let progressInterval = null;

        const analysisSteps = [
            "Initializing Analysis...",
            "Running Error Level Analysis (ELA)",
            "Analyzing Color Filter Array (CFA)",
            "Calculating Wavelet Statistics (HOS)",
            "Scanning for JPEG Ghost Artifacts",
            "Executing RAMBiNo Statistical Analysis",
            "Checking 3D Geometric Consistency",
            "Verifying Scene Lighting Consistency",
            "Applying Specialized CGI/AIGC Detectors",
            "Finalizing Report..."
        ];

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', (event) => {
            event.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFiles(files);
            }
        });

        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files && files.length > 0) {
                handleFiles(files);
            }
        });

        function handleFiles(files) {
            lastImageFile = files[0]; // Store the file
            const reader = new FileReader();

            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                dropZone.style.display = 'none';
                imagePreviewContainer.style.display = 'block';
                analyzeButton.style.display = 'block';
                resultsDiv.innerHTML = '';
                reportDiv.innerHTML = '';
                reportingContainer.style.display = 'none'; // Hide reporting section
                reportForm.style.display = 'none';
                showReportFormButton.style.display = 'block';
                reportStatus.innerHTML = '';
            };
            reader.readAsDataURL(lastImageFile);
        }

        function startProgressSimulator() {
            let currentStep = 0;
            progressContainer.style.display = 'block';

            progressInterval = setInterval(() => {
                currentStep++;
                const progressPercentage = Math.min(95, (currentStep / analysisSteps.length) * 100); // Don't go to 100%

                progressBarFill.style.width = `${progressPercentage}%`;
                progressBarFill.innerText = `${Math.round(progressPercentage)}%`;

                if(currentStep < analysisSteps.length) {
                    progressText.innerText = `Step ${currentStep}/${analysisSteps.length - 1}: ${analysisSteps[currentStep]}`;
                } else {
                    progressText.innerText = "Waiting for final server response...";
                }

            }, 2000); // Update every 2 seconds
        }

        function stopProgressSimulator() {
            clearInterval(progressInterval);
            progressBarFill.style.width = `100%`;
            progressBarFill.innerText = `100%`;
            progressText.innerText = "Analysis Complete!";
            // Hide the progress bar after a short delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 1000);
        }

        clearImageButton.addEventListener('click', () => {
            imagePreview.src = '#';
            dropZone.style.display = 'block';
            imagePreviewContainer.style.display = 'none';
            analyzeButton.style.display = 'none';
            fileInput.value = '';
            resultsDiv.innerHTML = '';
            reportDiv.innerHTML = '';
            reportingContainer.style.display = 'none'; // Hide reporting section
            lastAnalysisResult = null;
            lastImageFile = null;
        });

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            // Clear previous results and start progress simulator
            resultsDiv.innerHTML = '';
            reportDiv.innerHTML = '';
            document.getElementById('analysisDuration').innerHTML = '';
            reportingContainer.style.display = 'none';
            reportStatus.innerHTML = '';
            startProgressSimulator();

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'Unknown error from server');
                }

                const data = await response.json();
                lastAnalysisResult = data.prediction; // Store the prediction object

                let durationHtml = ``;
                if (data.prediction && data.prediction.analysis_duration) {
                    durationHtml += `<p><strong>Backend analysis time:</strong> ${data.prediction.analysis_duration} seconds.</p>`;
                }
                document.getElementById('analysisDuration').innerHTML = durationHtml;

                const prediction = data.prediction.prediction;
                const confidence = (data.prediction.confidence * 100).toFixed(2);

                let resultHtml = `<h2>Analysis Result for ${data.filename}:</h2>`;
                if (prediction === 'cgi') {
                    resultHtml += `<p>This image is likely <span class="prediction-cgi">CGI </span> with ${confidence}% confidence.</p>`;
                } else {
                    resultHtml += `<p>Cannot be certain <span class="prediction-real">Non-CGI</span> ${confidence}% confidence.</p>`;
                }
                resultsDiv.innerHTML = resultHtml;

                if (data.prediction.analysis_breakdown) {
                    let reportHtml = '<h3>Forensic Analysis Breakdown</h3>';
                    reportHtml += '<table class="report-table">';
                    reportHtml += '<tr><th>Feature</th><th>Calculated Score</th><th>Insight</th></tr>';
                    data.prediction.analysis_breakdown.forEach(metric => {
                        const [min, max] = metric.normal_range;
                        const tooltipText = `Normal range: ${min.toFixed(2)} - ${max.toFixed(2)}. Scores above this range suggest CGI or manipulation.`;
                        reportHtml += `<tr>
                            <td>
                                <a href="${metric.url}" target="_blank">${metric.feature}</a>
                                <div class="tooltip">
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltiptext">${tooltipText}</span>
                                </div>
                            </td>
                            <td>${metric.score.toFixed(2)}</td>
                            <td>${metric.insight}</td>
                        </tr>`;
                    });
                    reportHtml += '</table>';
                    reportHtml += '<h4 style="margin-top: 20px;">Visual Analysis</h4>';
                    data.prediction.analysis_breakdown.forEach(metric => {
                        const [min, max] = metric.normal_range;
                        const rangeWidth = (max - min) * 100;
                        const rangeLeft = min * 100;
                        const scoreLeft = metric.score * 100;
                        const isNormalized = metric.score >= 0 && metric.score <= 1 && min >= 0 && max <= 1;
                        reportHtml += `<p><strong>${metric.feature}</strong></p>`;
                        reportHtml += '<div class="infographic-bar">';
                        reportHtml += `<div class="normal-range" style="left: ${rangeLeft}%; width: ${rangeWidth}%;"></div>`;
                        reportHtml += `<div class="score-marker" style="left: ${scoreLeft}%;"></div>`;
                        reportHtml += '</div>';
                        reportHtml += `<p style="margin: 4px 0 12px 0; font-size: 0.9em; color: #555;">
                            Normal range: ${min.toFixed(2)} – ${max.toFixed(2)}
                            &nbsp;|&nbsp; Possible values: 0.00 – 1.00
                            ${isNormalized ? ' (values are normalized to [0, 1] for consistent comparison across features).' : ''}
                        </p>`;
                    });
                    reportDiv.innerHTML = reportHtml;
                }

                reportingContainer.style.display = 'block'; // Show the reporting container

            } catch (error) {
                console.error('Error during analysis:', error);
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            } finally {
                stopProgressSimulator();
            }
        });

        showReportFormButton.addEventListener('click', () => {
            reportForm.style.display = 'block';
            showReportFormButton.style.display = 'none';
        });

        reportForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!lastImageFile || !lastAnalysisResult) {
                reportStatus.innerHTML = '<p style="color: red;">Error: No analysis result to report.</p>';
                return;
            }

            reportStatus.innerHTML = 'Submitting report...';

            const formData = new FormData();
            formData.append('file', lastImageFile);
            formData.append('userCorrection', document.getElementById('correctionType').value);
            formData.append('originalPrediction', JSON.stringify(lastAnalysisResult));

            try {
                const response = await fetch('/report', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'Failed to submit report');
                }

                reportStatus.innerHTML = '<p style="color: green;">Thank you for your feedback!</p>';
                reportForm.style.display = 'none';

            } catch (error) {
                console.error('Error submitting report:', error);
                reportStatus.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
